<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Allugou - Meus An√∫ncios</title>
  <link rel="icon" type="image/x-icon" href="assets/img/favicon-32x32.png">
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ===== CABE√áALHO ===== -->
  <header class="cabecalho">
    <div class="cabecalho-conteudo">
      <h1 class="logo"><a href="index.html">Allugou</a></h1>

      <div class="barra-pesquisa">
        <input type="text" placeholder="Buscar produtos..." />
        <button class="btn-pesquisar">üîç</button>
      </div>

      <nav class="navegacao">
        <a href="anunciar.html" class="nav-btn" id="btn-anunciar">Anuncie</a>
        <span id="usuario-logado" style="display: none;">
          <span id="nome-usuario"></span>
          <a href="#" id="btn-logout" class="nav-btn sair">Sair</a>
        </span>
      </nav>
    </div>
  </header>

  <!-- ===== CONTE√öDO PRINCIPAL ===== -->
  <main class="api-produtos">
    <h2>Meus an√∫ncios</h2>
    <p id="msg-usuario" style="margin-bottom: 20px; color: #2285e7;"></p>
    <div id="lista-meus-produtos" class="lista-produtos"></div>
  </main>

  <!-- ===== RODAP√â ===== -->
  <footer class="footer">
    <div class="footer-container">
      <div class="footer-col">
        <h3>Sobre n√≥s</h3>
        <p>
          A <strong>Allugou</strong> √© uma plataforma dedicada a facilitar o aluguel de produtos de forma pr√°tica, r√°pida e segura. 
          Conectamos pessoas que precisam de equipamentos, ferramentas e objetos com quem os oferece.
        </p>
      </div>

      <div class="footer-col">
        <h3>Fale conosco</h3>
        <ul>
          <li><a href="#">üìû (21) 99999-9999</a></li>
          <li><a href="#">‚úâÔ∏è contato@allugou.com.br</a></li>
          <li><a href="#">üìç S√£o Gon√ßalo - RJ</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h3>Tire suas d√∫vidas</h3>
        <ul>
          <li><a href="#">Como funciona?</a></li>
          <li><a href="#">Seguran√ßa e pagamentos</a></li>
          <li><a href="#">Pol√≠tica de devolu√ß√£o</a></li>
          <li><a href="#">Ajuda e suporte</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h3>Redes sociais</h3>
        <ul class="redes-sociais">
          <li><a href="#">Instagram</a></li>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">LinkedIn</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>SENAI/SG/RJ - 2025 - Allugou. Desenvolvimento de Sistemas.</p>
    </div>
  </footer>

  <!-- ===== SCRIPT ===== -->
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");
      const username = localStorage.getItem("username");
      const btnLogin = document.getElementById("btn-login");
      const usuarioLogado = document.getElementById("usuario-logado");
      const nomeUsuario = document.getElementById("nome-usuario");
      const btnLogout = document.getElementById("btn-logout");

      // Se n√£o estiver logado, redireciona
      if (!token || !username) {
        alert("Voc√™ precisa estar logado para acessar seus an√∫ncios.");
        window.location.href = "login.html";
        return;
      }

      // Mostra nome e bot√£o sair no header
      if (btnLogin) btnLogin.style.display = "none";
      if (usuarioLogado) usuarioLogado.style.display = "inline";
      if (nomeUsuario) nomeUsuario.textContent = username;

      // Logout
      if (btnLogout) {
        btnLogout.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            const response = await fetch("http://127.0.0.1:8000/api/logout/", {
              method: "POST",
              headers: token ? { Authorization: `Token ${token}` } : {},
            });

            if (response.ok) {
              localStorage.removeItem("token");
              localStorage.removeItem("username");
              alert("Voc√™ saiu da sua conta com sucesso.");
              window.location.href = "index.html";
            } else {
              alert("Erro ao sair da conta.");
            }
          } catch (err) {
            console.error("Erro ao sair:", err);
            alert("Erro ao conectar ao servidor.");
          }
        });
      }

      // Carregar an√∫ncios do usu√°rio
      document.getElementById("msg-usuario").textContent = `An√∫ncios publicados por ${username}:`;

      const lista = document.getElementById("lista-meus-produtos");

      try {
        const response = await fetch("http://127.0.0.1:8000/api/produtos/", {
          headers: { Authorization: `Token ${token}` },
        });

        if (!response.ok) throw new Error("Erro ao buscar an√∫ncios.");

        const produtos = await response.json();
        const meusProdutos = produtos.filter((p) => p.usuario === username);

        if (meusProdutos.length === 0) {
          lista.innerHTML = "<p>Voc√™ ainda n√£o publicou nenhum produto.</p>";
          return;
        }

        lista.innerHTML = meusProdutos.map(
          (p) => `
            <div class="produto">
              <img src="${
                p.imagem
                  ? (p.imagem.startsWith("http") ? p.imagem : "http://127.0.0.1:8000" + p.imagem)
                  : "assets/img/produto-placeholder.png"
              }" alt="${p.titulo}" />
              <h3>${p.titulo}</h3>
              <p class="categoria">${p.categoria}</p>
              <p class="descricao">${p.descricao}</p>
              <p class="preco">R$ ${parseFloat(p.preco).toFixed(2)} / dia</p>
              <button class="btn-excluir" data-id="${p.id}">Excluir an√∫ncio</button>
            </div>
          `
        ).join("");

        // Fun√ß√£o de exclus√£o de produto
        document.querySelectorAll(".btn-excluir").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const confirmar = confirm("Deseja realmente remover este an√∫ncio?");
            if (!confirmar) return;

            try {
              const delResponse = await fetch(`http://127.0.0.1:8000/api/produtos/${id}/`, {
                method: "DELETE",
                headers: { Authorization: `Token ${token}` },
              });

              if (delResponse.ok) {
                alert("O an√∫ncio foi removido com sucesso.");
                btn.parentElement.remove();
              } else {
                alert("N√£o foi poss√≠vel excluir este an√∫ncio.");
              }
            } catch (err) {
              console.error("Erro ao excluir:", err);
              alert("Falha ao tentar excluir o an√∫ncio.");
            }
          });
        });

      } catch (err) {
        console.error(err);
        lista.innerHTML = "<p>Erro ao carregar seus an√∫ncios. Tente novamente mais tarde.</p>";
      }
    });
  </script>
</body>
</html>
